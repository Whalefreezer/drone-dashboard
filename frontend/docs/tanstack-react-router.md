# TanStack React Router – File‑Based Routing (2 Routes)

This doc standardizes TanStack React Router using the Vite file‑based plugin, with exactly two routes to start:

- `/` renders the existing dashboard (`App.tsx`) unchanged
- `/admin` renders a simple admin page showing `clientKVRecordsAtom`

---

## 1) Install Packages

Run from `frontend/`.

```sh
# Core router (runtime dependency)
deno add npm:@tanstack/react-router@^1

# Devtools (optional, dev‑only)
deno add -D npm:@tanstack/router-devtools@^1

# File‑based routing (used in this project)
deno add -D npm:@tanstack/router-plugin@^1
```

Notes

- If `deno add` isn’t available in your Deno version, you can still import via `npm:` specifiers directly in code and lock with
  `deno cache`.
- After adding, run `deno cache -r src/main.tsx` (or `deno task dev`) once to update `deno.lock`.

---

## 2) File‑Based Routing Setup

We use the Vite plugin to generate a route tree from files in `src/routes/`.

### 2.1 Configure Vite

Edit `frontend/vite.config.ts` and add the plugin:

```ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { TanStackRouterVite } from '@tanstack/router-plugin/vite';

export default defineConfig({
	plugins: [react(), TanStackRouterVite()],
});
```

### 2.2 Create Route Files (Only 2 Routes)

Create `src/routes/` with these files:

- `src/routes/__root.tsx` (root layout and shared UI)
- `src/routes/index.tsx` (renders current `App.tsx` at `/`)
- `src/routes/admin.tsx` (shows `clientKVRecordsAtom` at `/admin`)

```ts
// src/routes/__root.tsx
import { Outlet } from '@tanstack/react-router';
import { createRootRouteWithContext, Link } from '@tanstack/react-router';
import { TanStackRouterDevtools } from '@tanstack/router-devtools';

interface RouterContext {
	// Add shared singletons here if needed (e.g., queryClient)
}

export const Route = createRootRouteWithContext<RouterContext>()({
	component: () => (
		<>
			<nav style={{ padding: 8 }}>
				<Link to='/'>Dashboard</Link> | <Link to='/admin'>Admin</Link>
			</nav>
			<main>
				<Outlet />
			</main>
			{import.meta.env.DEV && <TanStackRouterDevtools position='bottom-right' />}
		</>
	),
});
```

```ts
// src/routes/index.tsx
import { createFileRoute } from '@tanstack/react-router';
import App from '../App.tsx';

export const Route = createFileRoute('/')({
	// Render the existing dashboard as-is at the root
	component: App,
});
```

```ts
// src/routes/admin.tsx
import { createFileRoute } from '@tanstack/react-router';
import { useAtomValue } from 'jotai';
import { clientKVRecordsAtom } from '../state/pbAtoms.ts';

export const Route = createFileRoute('/admin')({
	component: Admin,
});

function Admin() {
	const kv = useAtomValue(clientKVRecordsAtom);
	return (
		<div style={{ padding: 16 }}>
			<h1>Client KV Records</h1>
			<pre style={{ whiteSpace: 'pre-wrap' }}>{JSON.stringify(kv, null, 2)}</pre>
		</div>
	);
}
```

````
### 2.3 Wire Up the Router
Update `src/main.tsx` to create and provide the router using the generated route tree `routeTree.gen`.

```ts
// src/main.tsx
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import { RouterProvider, createRouter } from '@tanstack/react-router'
import { routeTree } from './routeTree.gen' // generated by plugin

const router = createRouter({ routeTree, context: {} })

// Type augmentation for strong typing across the app
declare module '@tanstack/react-router' {
  interface Register { router: typeof router }
}

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <RouterProvider router={router} />
  </StrictMode>,
)
````

Start the dev server with `deno task dev` and visit `/` and `/admin`.

---

## 3) Common Patterns

---

### Links and Navigation

```tsx
import { Link, useNavigate } from '@tanstack/react-router'

<Link to="/admin">Admin</Link>

const navigate = useNavigate()
navigate({ to: '/admin' })
```

### Search Params (Validation)

```tsx
import { z } from 'zod';
import { createFileRoute } from '@tanstack/react-router';

const searchSchema = z.object({ q: z.string().default('') });

export const Route = createFileRoute('/admin')({
	validateSearch: searchSchema,
	component: () => {
		const { q } = Route.useSearch();
		return <div>Query: {q}</div>;
	},
});
```

### Error & Pending UI

```ts
export const Route = createFileRoute('/admin')({
	loader: async () => {/* optional */},
	pendingComponent: () => <div>Loading…</div>,
	errorComponent: ({ error }) => <div>Error: {String(error)}</div>,
});
```

### Auth Guards (beforeLoad)

```ts
export const Route = createFileRoute('/admin')({
	beforeLoad: ({ context, location }) => {
		if (!context.user) {
			throw redirect({ to: '/login', search: { redirect: location.href } });
		}
	},
	component: Admin,
});
```

### Code‑Splitting

- File‑based: `createLazyFileRoute('/path')({ component: LazyComp })`.
- Manual tree: `component: React.lazy(() => import('./SomePage'))` and wrap with `<Suspense>` in layouts.

### Devtools

```tsx
import { TanStackRouterDevtools } from '@tanstack/router-devtools';
{
	import.meta.env.DEV && <TanStackRouterDevtools position='bottom-right' />;
}
```

---

## 4) Testing Routes (Deno + JSDOM)

- Render components under a memory history to test navigation.
- Example using Testing Library:

```ts
// src/routes/__tests__/admin.test.tsx
import { render, screen } from '@testing-library/react';
import { createMemoryHistory, RouterProvider } from '@tanstack/react-router';
import { createRouter } from '@tanstack/react-router';
import { routeTree } from '../../routeTree.gen';

Deno.test('renders admin page', () => {
	const router = createRouter({ routeTree });
	const history = createMemoryHistory({ initialEntries: ['/admin'] });
	render(<RouterProvider router={router} history={history} />);
	screen.getByText('Client KV Records');
});
```

---

## 5) Migration Tips

- Keep `App.tsx` as the dashboard surface and simply render it in `src/routes/index.tsx`.
- Expand `/admin` later with real controls; for now it’s a read‑only view of `clientKVRecordsAtom`.
- If adding more pages, create additional files under `src/routes/` and rely on the plugin to regenerate `routeTree.gen`.

---

## 6) Checklist (PR Acceptance Criteria)

- [ ] Packages installed and locked in `deno.lock`.
- [ ] Vite plugin configured.
- [ ] `src/main.tsx` uses `RouterProvider` with type registration.
- [ ] Exactly two routes exist: `/` (renders `App`) and `/admin` (renders atom dump).
- [ ] `/admin` compiles and shows `clientKVRecordsAtom` data as JSON.
- [ ] Devtools enabled only in development.
- [ ] Basic route test added and passing under `deno test`.

---

## 7) Commands

```sh
# Dev server
cd frontend && deno task dev

# Build
cd frontend && deno task build

# Tests
cd frontend && deno test
```

---

## 8) Notes for Backend Proxy

All examples assume API calls to `/api/*` are proxied by the Go backend (run backend with `-fpvtrackside-api=...`). Loaders fetch relative
paths (e.g., `/api/races/:id`) so they keep working in dev and in the embedded, built app.
